pipeline {
    agent {
      kubernetes {
            label 'jenkins-jenkins-agent'
            defaultContainer 'dind'
        }
    }

    environment {
        SERVER_CLUSTER = credentials('SERVER_CLUSTER')
        ACAJAS_TOKEN = credentials('ACAJAS_TOKEN')
        SPRING_DB_NAME = credentials('SPRING_DB_NAME')
        SPRING_DB_USER = credentials('SPRING_DB_USER')
        SPRING_DB_PASSWORD = credentials('SPRING_DB_PASSWORD')
    }

    parameters {
        string(name: 'repo', defaultValue: 'repositorio')
        string(name: 'desarrollo', defaultValue: 'develop-backend')
    }

    stages {
        stage('Clonar otro repositorio') {
            steps {
                script {
                    dir('repo') {
                        git branch: 'develop', url: """https://github.com/stemdo-labs/${repo}"""
                    }
                }
            }
        }

        stage('Log in del cluster') {
            steps {
                script {
                    sh """oc login --token=${ACAJAS_TOKEN} --server=${SERVER_CLUSTER}"""
                }
            }
        }

        stage('Crear ns') {
            steps {
                script {
                    sh """
                    if ! oc get ns acajas > /dev/null 2>&1; then
                        oc create ns acajas
                    fi
                    """
                }
            }
        }

        stage('Crear secreto para conexiÃ³n con base de datos') {
            steps {
                script {
                    def desarrollo = 'backend'
                    if (desarrollo.contains("backend")) {
                        sh """
                        if ! oc get secrets secretos-backend -n acajas > /dev/null 2>&1; then
                          oc create secret generic secretos-backend \
                            --from-literal=SPRING_DB_HOST=10.251.1.6 \
                            --from-literal=SPRING_DB_PORT=5432 \
                            --from-literal=SPRING_DB_NAME=${SPRING_DB_NAME} \
                            --from-literal=SPRING_DB_USER=${SPRING_DB_USER} \
                            --from-literal=SPRING_DB_PASSWORD=${SPRING_DB_PASSWORD} \
                            -n acajas
                        fi
                        """
                    } else {
                        echo "No es un entorno backend, no se crea el secreto."
                    }
                }
            }
        }

        stage('Instalar IBM CLI') {
            steps {
                sh 'curl -fsSL https://clis.cloud.ibm.com/install/linux | sh'
            }
        }

        stage('IBM Cloud Login') {
            steps {
                sh '''
                    ibmcloud login --apikey ${APIKEY_IBM_ACAJAS} -r eu-gb
                    ibmcloud target -g Stemdo_Sandbox
                '''
            }
        }

        stage('Instalar Plugin CR') {
            steps {
                sh 'ibmcloud plugin install container-registry'
            }
        }

        stage('Login en IBM Container Registry') {
            steps {
                sh 'ibmcloud cr login --client docker'
            }
        }

        stage('Instalar Chart') {
            steps {
                script {
                    def desarrollo = "backend-development"
                    dir('repo/templates') {
                        if (desarrollo == "backend-development") {
                            sh """
                            helm upgrade --install ${desarrollo} oci://uk.icr.io/acajas-cr-namespace/acajas/backend -f values-dev.yml -n acajas
                            """
                        } else if (desarrollo == "backend-production") {
                            sh """
                            helm upgrade --install ${desarrollo} oci://uk.icr.io/acajas-cr-namespace/acajas/backend -f values-prod.yml -n acajas
                            """
                        } else if (desarrollo == "frontend-development") {
                            sh """
                            helm upgrade --install ${desarrollo} oci://uk.icr.io/acajas-cr-namespace/acajas/frontend -f values-dev.yml -n acajas
                            """
                        } else if (desarrollo == "frontend-production") {
                            sh """
                            helm upgrade --install ${desarrollo} oci://uk.icr.io/acajas-cr-namespace/acajas/frontend -f values-prod.yml -n acajas
                            """
                        }
                    }
                }
            }
        }
    }
}